<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>mapOS | surveys://index</title>

    <link rel="stylesheet" href="/styles.css">
</head>

<body class="log-page" data-theme="dark">
    <header class="log-header">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
                <div class="coordinate">surveys://index</div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <a class="nav-pill" href="/index.html" aria-label="Back to main index">← Return to mapOS</a>
                <button id="themeToggle" class="nav-pill" type="button" aria-label="Toggle light/dark mode">
                    ☀︎/☾ theme
                </button>
            </div>
        </div>

        <h1>Surveys — Coordinate Index</h1>
        <div class="classification">mapOS • Cartographer of Networks • Searchable map registry</div>
    </header>

    <section class="log-summary">
        <p>
            This page is generated dynamically from <code>/surveys/_index.json</code>.
            Add new surveys by updating the manifest entry — the registry renders automatically.
        </p>

        <div class="two-column" style="margin-top:12px;">
            <div>
                <label for="q"
                    style="display:block; font-family: var(--map-font-mono); font-size:12px; color: var(--map-muted); margin-bottom:6px;">
                    Search (MAP id, title, platform, tags)
                </label>
                <input id="q" type="search" placeholder="e.g., MAP-2026/001, htb, windows, sqli, privesc"
                    style="width:100%; padding:10px 12px; border-radius: 12px; border:1px solid var(--map-border); background: rgba(0,0,0,0.18); color: var(--map-text); font-family: var(--map-font-mono);">
            </div>

            <div>
                <label for="platform"
                    style="display:block; font-family: var(--map-font-mono); font-size:12px; color: var(--map-muted); margin-bottom:6px;">
                    Platform filter
                </label>
                <select id="platform"
                    style="width:100%; padding:10px 12px; border-radius: 12px; border:1px solid var(--map-border); background: rgba(0,0,0,0.18); color: var(--map-text); font-family: var(--map-font-mono);">
                    <option value="">All platforms</option>
                </select>
            </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button id="sortNewest" type="button"
                style="padding:8px 10px; border-radius: 999px; border: 1px solid rgba(42,161,152,0.45); background: rgba(42,161,152,0.10); color: var(--map-text); font-family: var(--map-font-mono); cursor:pointer;">
                Sort: Newest
            </button>
            <button id="sortAlpha" type="button"
                style="padding:8px 10px; border-radius: 999px; border: 1px solid rgba(38,139,210,0.45); background: rgba(38,139,210,0.10); color: var(--map-text); font-family: var(--map-font-mono); cursor:pointer;">
                Sort: A→Z
            </button>
            <span id="count" class="muted" style="align-self:center;"></span>
        </div>
    </section>

    <section class="log-section">
        <h2>Registry</h2>
        <div id="status" class="note" style="display:none;"></div>
        <div id="grid"
            style="margin-top:12px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px;"></div>
    </section>

    <footer class="log-footer">
        rightrice — Cartographer of Networks
    </footer>

    <script>
        (() => {
            const MANIFEST_URL = "/surveys/_index.json";

            const els = {
                q: document.getElementById("q"),
                platform: document.getElementById("platform"),
                grid: document.getElementById("grid"),
                status: document.getElementById("status"),
                count: document.getElementById("count"),
                sortNewest: document.getElementById("sortNewest"),
                sortAlpha: document.getElementById("sortAlpha"),
            };

            let entries = [];
            let sortMode = "newest"; // newest | alpha

            function showStatus(msg) {
                els.status.style.display = "block";
                els.status.textContent = msg;
            }

            function hideStatus() {
                els.status.style.display = "none";
                els.status.textContent = "";
            }

            function normalize(s) {
                return (s || "").toString().toLowerCase().trim();
            }

            function uniqueSorted(arr) {
                return [...new Set(arr)].filter(Boolean).sort((a, b) => a.localeCompare(b));
            }

            function parseDate(d) {
                const t = Date.parse(d);
                return Number.isFinite(t) ? t : 0;
            }

            function buildPlatformOptions() {
                const plats = uniqueSorted(entries.map(e => e.platform));
                for (const p of plats) {
                    const opt = document.createElement("option");
                    opt.value = p;
                    opt.textContent = p;
                    els.platform.appendChild(opt);
                }
            }

            function entryMatches(e, q, platform) {
                if (platform && e.platform !== platform) return false;

                if (!q) return true;
                const hay = [
                    e.map,
                    e.coordinate,
                    e.title,
                    e.platform,
                    e.target,
                    e.os,
                    e.difficulty,
                    e.terrain,
                    e.vector,
                    (e.tags || []).join(" "),
                    (e.related || []).join(" "),
                ].map(normalize).join(" | ");
                return hay.includes(q);
            }

            function sortEntries(list) {
                if (sortMode === "alpha") {
                    return [...list].sort((a, b) => (a.title || "").localeCompare(b.title || ""));
                }
                return [...list].sort((a, b) => parseDate(b.updated) - parseDate(a.updated));
            }

            function pill(text) {
                const span = document.createElement("span");
                span.style.display = "inline-flex";
                span.style.alignItems = "center";
                span.style.gap = "6px";
                span.style.padding = "4px 8px";
                span.style.borderRadius = "999px";
                span.style.border = "1px solid rgba(88,110,117,0.35)";
                span.style.background = "rgba(0,0,0,0.14)";
                span.style.fontFamily = "var(--map-font-mono)";
                span.style.fontSize = "12px";
                span.style.color = "var(--map-muted)";
                span.textContent = text;
                return span;
            }

            function tagPill(text) {
                const tag = pill(`#${text}`);
                tag.style.border = "1px solid rgba(42,161,152,0.25)";
                tag.style.background = "rgba(42,161,152,0.06)";
                return tag;
            }

            function metaPill(text) {
                const m = pill(text);
                m.style.border = "1px solid rgba(38,139,210,0.30)";
                m.style.background = "rgba(38,139,210,0.06)";
                return m;
            }

            function card(e) {
                const a = document.createElement("a");
                a.href = e.href;
                a.style.display = "block";
                a.style.padding = "14px 14px";
                a.style.borderRadius = "14px";
                a.style.border = "1px solid rgba(88,110,117,0.35)";
                a.style.background = "rgba(0,0,0,0.14)";
                a.style.boxShadow = "0 6px 18px rgba(0,0,0,0.18)";
                a.style.textDecoration = "none";

                const top = document.createElement("div");
                top.style.display = "flex";
                top.style.justifyContent = "space-between";
                top.style.gap = "10px";
                top.style.alignItems = "baseline";

                // Display your MAP coordinate as the primary coordinate line
                const mapId = document.createElement("div");
                mapId.style.fontFamily = "var(--map-font-mono)";
                mapId.style.fontSize = "12px";
                mapId.style.color = "var(--map-muted)";
                mapId.textContent = e.map || e.coordinate;

                const date = document.createElement("div");
                date.style.fontFamily = "var(--map-font-mono)";
                date.style.fontSize = "12px";
                date.style.color = "var(--map-dim)";
                date.textContent = e.updated ? `updated: ${e.updated}` : "";

                top.appendChild(mapId);
                top.appendChild(date);

                const title = document.createElement("div");
                title.style.marginTop = "8px";
                title.style.fontSize = "16px";
                title.style.color = "var(--map-text)";
                title.style.fontWeight = "650";
                title.textContent = e.title || e.map || e.coordinate;

                const meta = document.createElement("div");
                meta.style.marginTop = "8px";
                meta.style.display = "flex";
                meta.style.flexWrap = "wrap";
                meta.style.gap = "8px";

                if (e.platform) meta.appendChild(pill(`Platform: ${e.platform}`));
                if (e.target) meta.appendChild(pill(`Target: ${e.target}`));

                if (e.os) meta.appendChild(metaPill(`OS: ${e.os}`));
                if (e.difficulty) meta.appendChild(metaPill(`Difficulty: ${e.difficulty}`));
                if (e.terrain) meta.appendChild(metaPill(`Terrain: ${e.terrain}`));
                if (e.vector) meta.appendChild(metaPill(`Vector: ${e.vector}`));

                const desc = document.createElement("div");
                desc.style.marginTop = "10px";
                desc.style.color = "var(--map-muted)";
                desc.style.fontSize = "13px";
                desc.textContent = e.description || "";

                const tags = document.createElement("div");
                tags.style.marginTop = "12px";
                tags.style.display = "flex";
                tags.style.flexWrap = "wrap";
                tags.style.gap = "8px";

                for (const t of (e.tags || []).slice(0, 6)) {
                    tags.appendChild(tagPill(t));
                }

                a.appendChild(top);
                a.appendChild(title);
                if (meta.childNodes.length) a.appendChild(meta);
                if (e.description) a.appendChild(desc);
                if ((e.tags || []).length) a.appendChild(tags);

                return a;
            }

            function render() {
                const q = normalize(els.q.value);
                const platform = els.platform.value;

                const filtered = entries.filter(e => entryMatches(e, q, platform));
                const sorted = sortEntries(filtered);

                const wide = window.matchMedia("(min-width: 940px)").matches;
                els.grid.style.gridTemplateColumns = wide ? "repeat(2, minmax(0, 1fr))" : "repeat(1, minmax(0, 1fr))";

                els.grid.innerHTML = "";
                for (const e of sorted) els.grid.appendChild(card(e));

                els.count.textContent = `${sorted.length} / ${entries.length} maps`;
            }

            async function init() {
                try {
                    showStatus(`Loading manifest: ${MANIFEST_URL}`);
                    const res = await fetch(MANIFEST_URL, { cache: "no-store" });
                    if (!res.ok) throw new Error(`HTTP ${res.status} fetching manifest`);
                    const data = await res.json();

                    if (!data || !Array.isArray(data.surveys)) throw new Error("Manifest missing { surveys: [...] }");

                    entries = data.surveys.map(x => ({
                        map: x.map || "",                   // "MAP-YYYY/NNN"
                        coordinate: x.coordinate || "",     // "survey://MAP-YYYY/NNN"
                        title: x.title || "",               // name it
                        href: x.href || "",                 // box name / engagement name
                        platform: x.platform || "",         // Hack The Box | TryHackMe | REDACTED | etc
                        target: x.target || "",             // 
                        os: x.os || "",                     // Windows | Linux | Network | Mixed
                        difficulty: x.difficulty || "",     // Easy | Medium | Hard | Insane (or your scale)
                        terrain: x.terrain || "",           // AD | Web | Cloud | Network | Mixed
                        vector: x.vector || "",             // initial access vector summary (safe)
                        description: x.description || "",
                        tags: Array.isArray(x.tags) ? x.tags : [],
                        related: Array.isArray(x.related) ? x.related : [],
                        updated: x.updated || "",
                    })).filter(e => e.href && (e.map || e.coordinate));

                    hideStatus();
                    buildPlatformOptions();
                    render();
                } catch (err) {
                    showStatus(`Failed to load survey index. ${err.message}`);
                    console.error(err);
                }
            }

            els.q.addEventListener("input", render);
            els.platform.addEventListener("change", render);
            window.addEventListener("resize", render);

            els.sortNewest.addEventListener("click", () => {
                sortMode = "newest";
                els.sortNewest.style.borderColor = "rgba(42,161,152,0.55)";
                els.sortAlpha.style.borderColor = "rgba(38,139,210,0.45)";
                render();
            });

            els.sortAlpha.addEventListener("click", () => {
                sortMode = "alpha";
                els.sortAlpha.style.borderColor = "rgba(42,161,152,0.55)";
                els.sortNewest.style.borderColor = "rgba(42,161,152,0.45)";
                render();
            });

            init();
        })();

        (() => {
            const STORAGE_KEY = "mapos-theme";
            const body = document.body;
            const btn = document.getElementById("themeToggle");

            function getPreferredTheme() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved === "light" || saved === "dark") return saved;
                return window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
            }

            function applyTheme(theme) {
                body.setAttribute("data-theme", theme);
                localStorage.setItem(STORAGE_KEY, theme);
                if (btn) btn.textContent = theme === "light" ? "☾ dark" : "☀︎ light";
            }

            applyTheme(getPreferredTheme());

            if (btn) {
                btn.addEventListener("click", () => {
                    const current = body.getAttribute("data-theme") || "dark";
                    applyTheme(current === "dark" ? "light" : "dark");
                });
            }
        })();
    </script>
</body>

</html>