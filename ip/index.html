<!doctype html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>mapOS | ip://lookup</title>

    <link rel="stylesheet" href="../../styles.css">
</head>

<body>
    <a class="skip-link" href="#main">Skip to content</a>
    <header class="site-header">
        <div class="container header-inner">
            <a class="brand" href="/">
                <span class="brand-mark">▦</span>
                <span class="brand-text">mapOS</span>
            </a>

            <nav class="nav" aria-label="Primary">
                <a class="nav-link" href="/">Maproom</a>
                <a class="nav-link" href="/instruments/">Instruments</a>
                <a class="nav-link" href="/logs/">Logs</a>
                <a class="nav-link" href="/surveys/">Survey Room</a>
                <a class="nav-link" href="/telegraph/">Telegraph</a>
            </nav>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-ghost" id="themeToggle" type="button" aria-label="Toggle theme">
                    <span class="btn-icon">☾</span>
                    <span class="btn-text" id="themeLabel">Moon</span>
                </button>

                <a class="btn btn-primary" href="/instruments/">
                    <span class="btn-text">Enter Instrument Bay</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main" class="page">
        <div class="container">
            <header class="page-head">
                <p class="breadcrumbs"><a href="/">mapOS</a> / <span class="mono">ip://lookup</span></p>
                <h1 class="page-title">Public IP Probe</h1>
                <p class="page-desc">
                    Fast, ad-free lookup. Uses Cloudflare trace first (Pages), falls back to ipify if trace is
                    unavailable.
                </p>

                <div class="hero-cta">
                    <button class="btn" id="refresh" type="button">
                        <span class="btn-icon">↻</span>
                        <span class="btn-text">Refresh</span>
                    </button>
                    <button class="btn" id="copyIp" type="button">
                        <span class="btn-icon">⎘</span>
                        <span class="btn-text">Copy IP</span>
                    </button>
                </div>
            </header>

            <div class="split">
                <!-- Left: results -->
                <section class="content" aria-label="IP results">
                    <h2>Signal</h2>

                    <div class="callout" style="margin-bottom:14px;">
                        <div class="callout-title mono" id="status">PS C:\rightrice&gt; probing…</div>
                        <div class="callout-body muted mono" id="source">source: —</div>
                    </div>

                    <div class="kv">
                        <div class="k">ip</div>
                        <div class="v mono" id="ip">loading…</div>
                    </div>
                    <div class="kv">
                        <div class="k">loc</div>
                        <div class="v mono" id="loc">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">colo</div>
                        <div class="v mono" id="colo">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">tls</div>
                        <div class="v mono" id="tls">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">ua</div>
                        <div class="v mono" id="ua">—</div>
                    </div>

                    <p class="hint" id="toast" style="display:none; margin-top:12px;"></p>

                    <div class="note">
                        Displays your <b>public</b> IP (internet-facing). This page does not attempt private/LAN IP
                        discovery.
                    </div>
                </section>

                <!-- Right: raw trace / troubleshooting -->
                <aside class="panel" aria-label="Trace output">
                    <h3>Trace</h3>

                    <div class="kv">
                        <div class="k">endpoint</div>
                        <div class="v mono">/cdn-cgi/trace</div>
                    </div>

                    <div class="kv">
                        <div class="k">fallback</div>
                        <div class="v mono">api64.ipify.org</div>
                    </div>

                    <p class="hint">
                        Raw trace is useful when you’re validating routing, colo, TLS, or debugging VPN/proxy behavior.
                    </p>

                    <pre class="codeblock"><code id="trace">loading…</code></pre>
                </aside>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container footer-inner">
            <span class="badge">© mapOS / rightrice</span>
            <span class="muted mono">last updated: <span id="updated"></span></span>
        </div>
    </footer>

    <script>
        // footer stamp
        document.getElementById("updated").textContent = new Date(document.lastModified).toLocaleString();

        // theme (uses html[data-theme], matching your token system)
        const root = document.documentElement;
        const themeLabel = document.getElementById("themeLabel");
        const THEME_KEY = "mapos_theme";

        function applyTheme(t) {
            const theme = (t === "light") ? "light" : "dark";
            root.dataset.theme = theme;
            themeLabel.textContent = theme === "light" ? "Sun" : "Moon";
            try { localStorage.setItem(THEME_KEY, theme); } catch { }
        }

        try {
            const saved = localStorage.getItem(THEME_KEY);
            if (saved) applyTheme(saved);
            else applyTheme(root.dataset.theme || "dark");
        } catch {
            applyTheme(root.dataset.theme || "dark");
        }

        document.getElementById("themeToggle").addEventListener("click", () => {
            applyTheme(root.dataset.theme === "dark" ? "light" : "dark");
        });
    </script>

    <script>
        const els = {
            status: document.getElementById("status"),
            source: document.getElementById("source"),
            ip: document.getElementById("ip"),
            loc: document.getElementById("loc"),
            colo: document.getElementById("colo"),
            tls: document.getElementById("tls"),
            ua: document.getElementById("ua"),
            trace: document.getElementById("trace"),
            toast: document.getElementById("toast"),
            refresh: document.getElementById("refresh"),
            copy: document.getElementById("copyIp"),
        };

        function toast(msg) {
            els.toast.textContent = msg;
            els.toast.style.display = "block";
            setTimeout(() => { els.toast.style.display = "none"; }, 1200);
        }

        function parseTrace(text) {
            const obj = {};
            text.split("\n").forEach(line => {
                const idx = line.indexOf("=");
                if (idx > 0) obj[line.slice(0, idx).trim()] = line.slice(idx + 1).trim();
            });
            return obj;
        }

        async function fetchCloudflareTrace() {
            const res = await fetch("/cdn-cgi/trace", { cache: "no-store" });
            if (!res.ok) throw new Error("cf trace unavailable");
            const raw = await res.text();
            const t = parseTrace(raw);
            return {
                raw,
                ip: t.ip || null,
                loc: t.loc || "—",
                colo: t.colo || "—",
                tls: t.tls || "—",
                source: "cloudflare:/cdn-cgi/trace",
            };
        }

        async function fetchIpifyFallback() {
            const res = await fetch("https://api64.ipify.org?format=json", { cache: "no-store" });
            if (!res.ok) throw new Error("ipify failed");
            const data = await res.json();
            return {
                raw: "",
                ip: data.ip || null,
                loc: "—",
                colo: "—",
                tls: "—",
                source: "ipify:fallback",
            };
        }

        async function load() {
            els.status.textContent = "PS C:\\rightrice> probing…";
            els.source.textContent = "source: —";
            els.ip.textContent = "loading…";
            els.loc.textContent = "—";
            els.colo.textContent = "—";
            els.tls.textContent = "—";
            els.ua.textContent = navigator.userAgent || "—";
            els.trace.textContent = "loading…";

            try {
                const info = await fetchCloudflareTrace();
                if (!info.ip) throw new Error("trace missing ip");

                els.status.textContent = "PS C:\\rightrice> ok";
                els.source.textContent = "source: " + info.source;
                els.ip.textContent = info.ip;
                els.loc.textContent = info.loc;
                els.colo.textContent = info.colo;
                els.tls.textContent = info.tls;
                els.trace.textContent = info.raw.trim() || "(empty)";
                return;
            } catch (_) { }

            try {
                const info = await fetchIpifyFallback();
                if (!info.ip) throw new Error("ipify missing ip");

                els.status.textContent = "PS C:\\rightrice> ok (fallback)";
                els.source.textContent = "source: " + info.source;
                els.ip.textContent = info.ip;
                els.trace.textContent = "(cloudflare trace unavailable; using fallback)";
            } catch (_) {
                els.status.textContent = "PS C:\\rightrice> failed";
                els.source.textContent = "source: error";
                els.ip.textContent = "error";
                els.trace.textContent = "error";
                toast("failed to fetch ip");
            }
        }

        els.refresh.addEventListener("click", load);

        els.copy.addEventListener("click", async () => {
            const val = (els.ip.textContent || "").trim();
            if (!val || val === "loading…" || val === "error") return toast("no ip to copy");
            try {
                await navigator.clipboard.writeText(val);
                toast("copied");
            } catch {
                toast("clipboard blocked");
            }
        });

        document.addEventListener("DOMContentLoaded", load);
    </script>
</body>

</html>